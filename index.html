<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RFEM Speaker PRO ‚Äì Modo Evento</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ====== ESTILOS SIN CAMBIOS ====== */
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #051937, #003973, #0077b6);
  background-attachment: fixed;
  color: white;
}

header {
  padding: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(10px);
}

header img { height: 50px; }

button {
  background: #00d1ff;
  border: none;
  padding: 14px 18px;
  font-size: 16px;
  font-weight: bold;
  border-radius: 14px;
  cursor: pointer;
}

.search-box {
  background: white;
  color: black;
  padding: 12px 16px;
  border-radius: 14px;
  font-size: 16px;
  border: none;
  min-width: 240px;
}

.section-title {
  text-align: center;
  font-size: 28px;
  margin: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 16px;
  padding: 20px;
}

@media (max-width: 1400px) { .grid { grid-template-columns: repeat(4,1fr);} }
@media (max-width: 1024px) { .grid { grid-template-columns: repeat(3,1fr);} }
@media (max-width: 600px)  { .grid { grid-template-columns: repeat(2,1fr);} }

.card {
  background: rgba(20,30,60,0.9);
  border-radius: 20px;
  padding: 14px;
  text-align: center;
}

.en-pista {
  border: 4px solid #00ff00;
}

.card img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: 14px;
  background: #000;
}

.overlay {
  position: fixed;
  inset: 0;
  background: rgba(5,10,25,0.97);
  display: none;
  padding: 20px;
  overflow-y: auto;
  z-index: 999;
}

input, textarea {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

.footer {
  display: flex;
  justify-content: center;
  gap: 40px;
  padding: 20px;
  background: rgba(0,0,0,0.6);
}
.footer img { height: 60px; }
</style>
</head>

<body>

<header>
  <img src="logo-gaston.png">
  <strong style="font-size:24px;">RFEM SPEAKER PRO</strong>
  <img src="logo-rfem.png">

  <button onclick="mostrarFormularioNuevo()">‚ûï Piloto</button>
  <button onclick="exportarBackup()">‚òÅÔ∏è Backup</button>
  <button onclick="importarBackup()">‚òÅÔ∏è Restaurar</button>

  <input id="buscador" class="search-box" placeholder="üîç Buscar piloto o dorsal" oninput="render()">
</header>

<h1 class="section-title">üèÅ PILOTOS</h1>
<div class="grid" id="grid"></div>

<!-- FORMULARIO -->
<div id="formulario" class="overlay">
  <button onclick="cerrarFormulario()">‚¨Ö Volver</button>
  <h2>Piloto</h2>

  <input id="n-nombre" placeholder="Nombre">
  <input id="n-piloto2" placeholder="Piloto 2">
  <input id="n-dorsal" placeholder="Dorsal">
  <input id="n-categoria" placeholder="Categor√≠a">
  <input id="n-club" placeholder="Club">
  <input id="n-embarcacion" placeholder="Embarcaci√≥n">
  <textarea id="n-observaciones" placeholder="Observaciones"></textarea>
  <input type="file" id="n-foto" accept="image/*">

  <button onclick="guardarPiloto()">üíæ Guardar</button>
</div>

<!-- FICHA -->
<div id="ficha" class="overlay">
  <button onclick="cerrarFicha()">‚¨Ö Volver</button>
  <button onclick="editarPiloto()">‚úèÔ∏è Editar</button>

  <h2 id="f-nombre"></h2>
  <p id="f-dorsal"></p>
  <p id="f-categoria"></p>
  <p id="f-observaciones"></p>
</div>

<div class="footer">
  <img src="logo-gaston.png">
  <img src="logo-rfem.png">
</div>

<script>
let competidores = JSON.parse(localStorage.getItem("rfemData")) || [];
let seleccionado = null;
let editando = null;

function render(){
  localStorage.setItem("rfemData", JSON.stringify(competidores));
  const g = document.getElementById("grid");
  g.innerHTML = "";

  const q = document.getElementById("buscador").value.toLowerCase();

  competidores.forEach((p,i)=>{
    if(q && !p.nombre.toLowerCase().includes(q) && !(p.dorsal||"").includes(q)) return;

    const c = document.createElement("div");
    c.className = "card";
    c.innerHTML = `
      <img src="${p.foto||""}">
      <div>${p.nombre}</div>
      <strong>${p.dorsal||""}</strong>
      <div>${p.categoria||""}</div>
    `;
    c.onclick = ()=>abrirFicha(i);
    g.appendChild(c);
  });
}

/* ====== √öNICA PARTE MODIFICADA ====== */
function guardarPiloto(){
  const base = editando!==null ? competidores[editando] : {};

  base.nombre = v("n-nombre");
  base.piloto2 = v("n-piloto2");
  base.dorsal = v("n-dorsal");
  base.categoria = v("n-categoria");
  base.club = v("n-club");
  base.embarcacion = v("n-embarcacion");
  base.observaciones = v("n-observaciones");

  const file = document.getElementById("n-foto").files[0];

  if(file){
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e=>{
      img.onload = ()=>{
        const canvas = document.createElement("canvas");
        canvas.width = canvas.height = 300;
        canvas.getContext("2d").drawImage(img,0,0,300,300);
        base.foto = canvas.toDataURL("image/jpeg",0.7);
        finalizarGuardado(base);
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  } else {
    finalizarGuardado(base);
  }
}

function finalizarGuardado(p){
  if(editando===null) competidores.push(p);
  cerrarFormulario();
  render();
}

function mostrarFormularioNuevo(){
  editando=null;
  ["n-nombre","n-piloto2","n-dorsal","n-categoria","n-club","n-embarcacion","n-observaciones"]
    .forEach(id=>document.getElementById(id).value="");
  document.getElementById("n-foto").value="";
  document.getElementById("formulario").style.display="block";
}

function abrirFicha(i){
  seleccionado=i;
  const p=competidores[i];
  document.getElementById("f-nombre").innerText=p.nombre;
  document.getElementById("f-dorsal").innerText="Dorsal: "+(p.dorsal||"");
  document.getElementById("f-categoria").innerText="Categor√≠a: "+(p.categoria||"");
  document.getElementById("f-observaciones").innerText=p.observaciones||"";
  document.getElementById("ficha").style.display="block";
}

function editarPiloto(){
  editando=seleccionado;
  const p=competidores[seleccionado];
  v("n-nombre",p.nombre);
  v("n-piloto2",p.piloto2);
  v("n-dorsal",p.dorsal);
  v("n-categoria",p.categoria);
  v("n-club",p.club);
  v("n-embarcacion",p.embarcacion);
  v("n-observaciones",p.observaciones);
  cerrarFicha();
  document.getElementById("formulario").style.display="block";
}

function exportarBackup(){
  const b=new Blob([JSON.stringify(competidores,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="rfem_backup.json";
  a.click();
}

function importarBackup(){
  const i=document.createElement("input");
  i.type="file";i.accept="application/json";
  i.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{competidores=JSON.parse(r.result);render();};
    r.readAsText(e.target.files[0]);
  };
  i.click();
}

function cerrarFormulario(){document.getElementById("formulario").style.display="none";}
function cerrarFicha(){document.getElementById("ficha").style.display="none";}
function v(id,val){if(val!==undefined)document.getElementById(id).value=val;return document.getElementById(id).value;}

render();
</script>

</body>
</html>
