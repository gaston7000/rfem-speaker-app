<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RFEM Speaker PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(120deg, #06162f, #0b3c5d, #04131f);
  background-size: 300% 300%;
  animation: bgMove 15s ease infinite;
  color: white;
}

@keyframes bgMove {
  0% { background-position: 0% 50% }
  50% { background-position: 100% 50% }
  100% { background-position: 0% 50% }
}

header {
  padding: 16px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(10px);
}

button {
  background: #00d1ff;
  border: none;
  padding: 12px 16px;
  font-size: 15px;
  font-weight: bold;
  border-radius: 12px;
  cursor: pointer;
}
button:hover {
  background: #00b4dd;
  transform: scale(1.05);
}

.search-box {
  background: white;
  color: black;
  padding: 12px;
  border-radius: 12px;
  border: none;
  min-width: 240px;
}

.section-title {
  text-align: center;
  font-size: 26px;
  margin: 20px;
  color: #00d1ff;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  gap: 16px;
  padding: 20px;
}

.card {
  background: rgba(20,30,60,0.9);
  border-radius: 18px;
  padding: 12px;
  text-align: center;
}

.en-pista {
  border: 4px solid #00ff00;
  box-shadow: 0 0 20px #00ff00;
}

.overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(5,10,25,0.96);
  display: none;
  padding: 20px;
  overflow-y: auto;
  z-index: 999;
}

input, textarea, select {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: none;
}

.timeline {
  display: flex;
  overflow-x: auto;
  gap: 12px;
}

.timeline-item {
  min-width: 240px;
  background: rgba(0,0,0,0.6);
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 0 10px #00d1ff;
}

.progress-box {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.85);
  padding: 14px 20px;
  border-radius: 12px;
  display: none;
  box-shadow: 0 0 20px #00d1ff;
}
</style>
</head>

<body>

<header>
  <button onclick="mostrarFormularioNuevo()">â• Piloto</button>
  <button onclick="importarPDF()">ğŸ“¥ Importar PDF RFEM</button>
  <button onclick="exportarBackup()">â˜ï¸ Backup</button>
  <button onclick="importarBackup()">â˜ï¸ Restaurar</button>

  <input id="buscador" class="search-box"
    placeholder="ğŸ” Buscar por nombre o dorsal..."
    oninput="render()">
</header>

<h1 class="section-title">ğŸ PARRILLA</h1>
<div class="grid" id="gridParrilla"></div>

<h1 class="section-title">ğŸ® EN PISTA</h1>
<div class="grid" id="gridPista"></div>

<h1 class="section-title">ğŸ† PILOTOS</h1>
<div class="grid" id="grid"></div>

<div class="progress-box" id="progressBox">
  <div id="progressText">Procesando PDF...</div>
</div>

<!-- ================== FORMULARIO ================= -->
<div id="formulario" class="overlay">
  <button onclick="cerrarFormulario()">â¬… Volver</button>
  <h2>Competidor</h2>

  <input id="n-nombre" placeholder="Piloto 1">
  <input id="n-piloto2" placeholder="Piloto 2 (Opcional)">
  <input id="n-dorsal" placeholder="Dorsal">
  <input id="n-categoria" placeholder="CategorÃ­a principal">
  <input id="n-club" placeholder="Club">
  <input id="n-embarcacion" placeholder="EmbarcaciÃ³n">
  <textarea id="n-observaciones" placeholder="Observaciones"></textarea>

  <button onclick="guardarFormulario()">ğŸ’¾ Guardar</button>
</div>

<!-- ================== FICHA ================= -->
<div id="ficha" class="overlay">
  <button onclick="cerrarFicha()">â¬… Volver</button>

  <h2 id="f-nombre"></h2>
  <p id="f-dorsal"></p>
  <p id="f-categoria"></p>
  <p id="f-club"></p>
  <p id="f-embarcacion"></p>

  <h3>ğŸ“ Observaciones</h3>
  <div id="f-observaciones"></div>

  <button onclick="toggleEnPista()">ğŸ® En pista</button>
  <button onclick="toggleParrilla(seleccionado)">ğŸ A/Q Parrilla</button>

  <h3>ğŸ—“ï¸ Historial</h3>
  <div class="timeline" id="f-timeline"></div>
</div>

<script>
let competidores = JSON.parse(localStorage.getItem("rfemData")) || [];
let seleccionado = null;

function guardarDatos() {
  localStorage.setItem("rfemData", JSON.stringify(competidores));
}

function render() {
  guardarDatos();
  const grid = document.getElementById("grid");
  const pista = document.getElementById("gridPista");
  const parrilla = document.getElementById("gridParrilla");

  grid.innerHTML = "";
  pista.innerHTML = "";
  parrilla.innerHTML = "";

  const q = document.getElementById("buscador").value.toLowerCase();

  competidores.forEach((p, i) => {
    if (q && !p.nombre.toLowerCase().includes(q) &&
        !String(p.dorsal || "").includes(q)) return;

    const card = document.createElement("div");
    card.className = "card" + (p.enPista ? " en-pista" : "");
    card.innerHTML = `
      <strong>${p.nombre}</strong><br>
      ğŸ·ï¸ ${p.dorsal || ""}<br>
      ğŸ“Š ${p.categoria || ""}
      <br><br>
      <button onclick="toggleParrilla(${i});event.stopPropagation()">
        ${p.enParrilla ? "â– Parrilla" : "â• Parrilla"}
      </button>
    `;
    card.onclick = () => abrirFicha(i);

    grid.appendChild(card);

    if (p.enPista) pista.appendChild(card.cloneNode(true));
    if (p.enParrilla) parrilla.appendChild(card.cloneNode(true));
  });
}

/* ================= PDF IMPORT ================= */
async function importarPDF() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/pdf";

  input.onchange = async e => {
    const file = e.target.files[0];
    if (!file) return;

    mostrarProgreso("Leyendo PDF...");

    try {
      const buffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({
        data: buffer,
        disableWorker: false
      }).promise;

      let texto = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        mostrarProgreso("Procesando pÃ¡gina " + i + " de " + pdf.numPages);
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        content.items.forEach(item => {
          texto += item.str + "\n";
        });
      }

      procesarTexto(texto);
    } catch (err) {
      alert("âŒ Error leyendo PDF:\n" + err.message);
    }

    ocultarProgreso();
  };

  input.click();
}

function procesarTexto(texto) {
  const lineas = texto.split("\n");
  let categoria = "RFEM";
  let importados = 0;
  const anio = new Date().getFullYear();

  lineas.forEach(linea => {
    linea = linea.trim();

    if (!linea) return;

    if (linea.toUpperCase().includes("RUNABOUT") ||
        linea.toUpperCase().includes("GP")) {
      categoria = linea;
      return;
    }

    const match = linea.match(/^(\d+)\s+(\d+)\s+(.+?)\s+(\d+)$/);
    if (!match) return;

    const puesto = match[1];
    const dorsal = match[2];
    const nombre = match[3].trim();
    const puntos = match[4];

    let piloto = competidores.find(p => p.nombre === nombre);

    if (!piloto) {
      piloto = {
        nombre,
        dorsal,
        categoria,
        club: "",
        embarcacion: "",
        observaciones: "",
        resultados: [],
        enPista: false,
        enParrilla: false
      };
      competidores.push(piloto);
    }

    piloto.resultados.push({
      anio,
      categoria,
      puesto,
      puntos
    });

    importados++;
  });

  guardarDatos();
  render();
  alert("âœ… PDF IMPORTADO\n\nResultados cargados: " + importados);
}

/* ================= CRUD ================= */
function mostrarFormularioNuevo() {
  document.getElementById("formulario").style.display = "block";
}

function cerrarFormulario() {
  document.getElementById("formulario").style.display = "none";
}

function guardarFormulario() {
  competidores.push({
    nombre: n("n-nombre"),
    piloto2: n("n-piloto2"),
    dorsal: n("n-dorsal"),
    categoria: n("n-categoria"),
    club: n("n-club"),
    embarcacion: n("n-embarcacion"),
    observaciones: n("n-observaciones"),
    resultados: [],
    enPista: false,
    enParrilla: false
  });
  cerrarFormulario();
  render();
}

function abrirFicha(i) {
  seleccionado = i;
  const p = competidores[i];

  f("f-nombre", p.nombre);
  f("f-dorsal", "Dorsal: " + p.dorsal);
  f("f-categoria", "CategorÃ­a: " + p.categoria);
  f("f-club", "Club: " + (p.club || "â€”"));
  f("f-embarcacion", "EmbarcaciÃ³n: " + (p.embarcacion || "â€”"));
  f("f-observaciones", p.observaciones || "â€”");

  const timeline = document.getElementById("f-timeline");
  timeline.innerHTML = "";

  (p.resultados || []).forEach(r => {
    const div = document.createElement("div");
    div.className = "timeline-item";
    div.innerHTML = `
      <strong>${r.anio}</strong><br>
      ${r.categoria}<br>
      ğŸ¥‡ Puesto: ${r.puesto}<br>
      â­ Puntos: ${r.puntos || ""}
    `;
    timeline.appendChild(div);
  });

  document.getElementById("ficha").style.display = "block";
}

function cerrarFicha() {
  document.getElementById("ficha").style.display = "none";
}

function toggleEnPista() {
  competidores[seleccionado].enPista = !competidores[seleccionado].enPista;
  render();
}

function toggleParrilla(i) {
  competidores[i].enParrilla = !competidores[i].enParrilla;
  render();
}

function exportarBackup() {
  const blob = new Blob([JSON.stringify(competidores, null, 2)], {
    type: "application/json"
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "rfem_backup.json";
  a.click();
}

function importarBackup() {
  const i = document.createElement("input");
  i.type = "file";
  i.accept = "application/json";
  i.onchange = e => {
    const r = new FileReader();
    r.onload = () => {
      competidores = JSON.parse(r.result);
      render();
    };
    r.readAsText(e.target.files[0]);
  };
  i.click();
}

function mostrarProgreso(txt) {
  document.getElementById("progressText").innerText = txt;
  document.getElementById("progressBox").style.display = "block";
}
function ocultarProgreso() {
  document.getElementById("progressBox").style.display = "none";
}

function n(id){ return document.getElementById(id).value; }
function f(id,val){ document.getElementById(id).innerText = val; }

render();
</script>

</body>
</html>
