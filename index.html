<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>RFEM Speaker App</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #0b1320;
  color: white;
  margin: 0;
}

header {
  background: #101c36;
  padding: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

button {
  background: #1e3a8a;
  border: none;
  padding: 10px 14px;
  color: white;
  border-radius: 10px;
  cursor: pointer;
}

button:hover {
  background: #2563eb;
}

#grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 10px;
  padding: 10px;
}

.card {
  background: #111827;
  border-radius: 12px;
  padding: 10px;
}

.en-pista {
  border: 3px solid #00ff00;
  box-shadow: 0 0 20px #00ff00;
}

input, select {
  width: 100%;
  margin-bottom: 6px;
  padding: 6px;
  border-radius: 6px;
  border: none;
}

#logos {
  display: flex;
  justify-content: center;
  gap: 40px;
  padding: 20px;
  background: #020617;
}

#logos img {
  height: 60px;
  opacity: 0.85;
}
</style>
</head>

<body>

<header>
  <button onclick="nuevoCompetidor()">‚ûï Competidor</button>
  <button onclick="importarPDF()">üåê Importar PDF RFEM</button>
  <button onclick="pantallaPublico()">üì∫ P√∫blico</button>
  <button onclick="exportarBackup()">‚òÅÔ∏è Backup</button>
  <button onclick="importarBackup()">‚òÅÔ∏è Restaurar</button>
</header>

<div id="grid"></div>

<div id="logos">
  <img src="https://upload.wikimedia.org/wikipedia/commons/4/4b/Real_Federacion_Espanola_de_Motonautica_logo.png">
  <img src="https://upload.wikimedia.org/wikipedia/commons/7/79/Federacion_Andaluza_de_Motonautica_logo.png">
  <img src="https://upload.wikimedia.org/wikipedia/commons/2/2d/UIM_logo.png">
  <img src="https://gastoniglesias.com/logo.png">
</div>

<script>
let competidores = JSON.parse(localStorage.getItem("rfemData") || "[]");
let seleccionado = null;

function guardar() {
  localStorage.setItem("rfemData", JSON.stringify(competidores));
}

function render() {
  guardar();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  competidores.forEach((p, i) => {
    const div = document.createElement("div");
    div.className = "card" + (p.enPista ? " en-pista" : "");
    div.innerHTML = `
      <b>${p.nombre}</b><br>
      üèÅ ${p.categoria || ""}<br>
      ‚≠ê Puntos: ${totalPuntos(p)}<br><br>
      <button onclick="abrirFicha(${i})">üìÑ Ficha</button>
    `;
    grid.appendChild(div);
  });
}

function totalPuntos(p) {
  return (p.resultados || []).reduce((s, r) => s + (parseInt(r.puntos)||0), 0);
}

function nuevoCompetidor() {
  const nombre = prompt("Nombre del competidor");
  if (!nombre) return;

  competidores.push({
    nombre,
    dorsal: "",
    club: "",
    categoria: "",
    tipo: "",
    embarcacion: "",
    familiar: "",
    foto: "",
    enPista: false,
    resultados: []
  });

  render();
}

function abrirFicha(i) {
  seleccionado = i;
  const p = competidores[i];

  const win = window.open("", "ficha");
  win.document.write(`
    <html>
    <body style="font-family:sans-serif;padding:20px">
      <h2>${p.nombre}</h2>
      <label>Dorsal</label>
      <input id="dorsal" value="${p.dorsal}"><br>
      <label>Club</label>
      <input id="club" value="${p.club}"><br>
      <label>Categor√≠a</label>
      <input id="cat" value="${p.categoria}"><br>
      <label>Tipo</label>
      <select id="tipo">
        <option ${p.tipo=="Motos de agua"?"selected":""}>Motos de agua</option>
        <option ${p.tipo=="Barcos"?"selected":""}>Barcos</option>
      </select><br>
      <label>Embarcaci√≥n</label>
      <input id="emb" value="${p.embarcacion}"><br>
      <label>Lazo familiar</label>
      <input id="fam" value="${p.familiar}"><br><br>

      <button onclick="guardar()">üíæ Guardar</button>
      <button onclick="toggle()">üéÆ En pista</button>

      <h3>Resultados</h3>
      <div id="res"></div>
      <button onclick="nuevoRes()">‚ûï Resultado</button>

      <script>
        const datos = opener.competidores[${i}];
        function renderRes() {
          const div = document.getElementById("res");
          div.innerHTML = "";
          datos.resultados.forEach(r => {
            div.innerHTML += r.a√±o + " - " + r.competicion + " | Puesto: " + r.puesto + " | Puntos: " + r.puntos + "<br>";
          });
        }
        renderRes();

        function nuevoRes() {
          const a√±o = prompt("A√±o");
          const comp = prompt("Competici√≥n");
          const puesto = prompt("Puesto");
          const puntos = prompt("Puntos");

          datos.resultados.push({a√±o, competicion: comp, puesto, puntos});
          renderRes();
          opener.render();
        }

        function guardar() {
          datos.dorsal = document.getElementById("dorsal").value;
          datos.club = document.getElementById("club").value;
          datos.categoria = document.getElementById("cat").value;
          datos.tipo = document.getElementById("tipo").value;
          datos.embarcacion = document.getElementById("emb").value;
          datos.familiar = document.getElementById("fam").value;
          opener.render();
        }

        function toggle() {
          datos.enPista = !datos.enPista;
          opener.render();
        }
      <\/script>
    </body>
    </html>
  `);
}

function pantallaPublico() {
  const win = window.open("", "publico");
  win.document.write(`
    <html>
    <body style="background:black;color:white;font-family:sans-serif;padding:20px">
      <h1>CLASIFICACI√ìN EN VIVO</h1>
      <div id="lista"></div>
      <script>
        function actualizar() {
          const datos = JSON.parse(localStorage.getItem("rfemData") || "[]");
          let lista = [];
          datos.forEach(p => {
            const total = p.resultados.reduce((s, r) => s + (parseInt(r.puntos)||0), 0);
            lista.push({nombre:p.nombre, puntos:total});
          });
          lista.sort((a,b)=>b.puntos-a.puntos);

          const div = document.getElementById("lista");
          div.innerHTML="";
          lista.slice(0,10).forEach((p,i)=>{
            div.innerHTML+=\`<div style="font-size:36px;margin:10px">#\${i+1} \${p.nombre} ‚Äî ‚≠ê \${p.puntos}</div>\`;
          });
        }
        setInterval(actualizar,2000);
        actualizar();
      <\/script>
    </body>
    </html>
  `);
}

function exportarBackup() {
  const data = JSON.stringify(competidores, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "rfem_backup.json";
  a.click();
}

function importarBackup() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = e => {
    const reader = new FileReader();
    reader.onload = () => {
      competidores = JSON.parse(reader.result);
      render();
    };
    reader.readAsText(e.target.files[0]);
  };
  input.click();
}

async function importarPDF() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/pdf";

  input.onchange = async e => {
    const file = e.target.files[0];
    const arrayBuffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;

    let texto = "";
    for (let i = 1; i <= pdf.numPages; i++) {
      const page = await pdf.getPage(i);
      const content = await page.getTextContent();
      content.items.forEach(item => texto += item.str + "\n");
    }

    procesarRFEM(texto);
  };

  input.click();
}

function procesarRFEM(texto) {
  const lineas = texto.split("\n");
  let competicion = "";
  let a√±o = new Date().getFullYear();

  lineas.forEach(l => {
    if (l === l.toUpperCase() && l.length > 10) {
      competicion = l;
    }

    const match = l.match(/^(\d+)[¬∫¬™]\s+(.+)/);
    if (match) {
      const puesto = match[1];
      const nombre = match[2].trim();

      let piloto = competidores.find(p => p.nombre === nombre);
      if (!piloto) {
        piloto = {nombre, resultados: []};
        competidores.push(piloto);
      }

      piloto.resultados.push({
        a√±o,
        competicion,
        puesto,
        puntos: ""
      });
    }
  });

  render();
  alert("PDF RFEM importado correctamente");
}

render();
</script>

</body>
</html>