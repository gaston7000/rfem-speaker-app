<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RFEM Speaker PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
  color: white;
}

header {
  padding: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(10px);
}

button {
  background: #00d1ff;
  border: none;
  padding: 14px 18px;
  font-size: 15px;
  font-weight: bold;
  border-radius: 14px;
  cursor: pointer;
}
button:hover {
  background: #00b4dd;
  transform: scale(1.05);
}

.search-box {
  background: white;
  color: black;
  padding: 12px 16px;
  border-radius: 14px;
  font-size: 16px;
  border: none;
  min-width: 240px;
}

.section-title {
  text-align: center;
  font-size: 26px;
  margin: 20px;
}

.info-box {
  max-width: 900px;
  margin: 0 auto;
  background: rgba(0,0,0,0.4);
  border-radius: 16px;
  padding: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px,1fr));
  gap: 16px;
  padding: 20px;
}

.card {
  background: rgba(20,30,60,0.9);
  border-radius: 18px;
  padding: 14px;
  text-align: center;
}
.card:hover { transform: scale(1.05); }

.en-pista {
  border: 4px solid #00ff00;
  box-shadow: 0 0 25px #00ff00;
}

.card img {
  width: 100%;
  height: 130px;
  object-fit: cover;
  border-radius: 12px;
}

.dorsal { font-size: 30px; font-weight: bold; }

.overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(5,10,25,0.95);
  display: none;
  padding: 20px;
  overflow-y: auto;
  z-index: 999;
}

input, textarea, select {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

.timeline {
  display: flex;
  overflow-x: auto;
  gap: 12px;
}

.timeline-item {
  min-width: 220px;
  background: rgba(0,0,0,0.5);
  border-radius: 14px;
  padding: 12px;
  text-align: center;
  box-shadow: 0 0 10px #00d1ff;
}

.footer {
  display: flex;
  justify-content: center;
  gap: 40px;
  padding: 20px;
  background: rgba(0,0,0,0.6);
}
.footer img { height: 60px; opacity: 0.85; }
</style>
</head>

<body>

<header>
  <button onclick="mostrarFormularioNuevo()">â• Nuevo Piloto</button>
  <button onclick="mostrarRanking()">ğŸ† Ranking</button>
  <button onclick="activarImportPDF()">ğŸ“„ Importar PDF RFEM</button>
  <button onclick="exportarBackup()">â˜ï¸ Backup</button>
  <button onclick="importarBackup()">â˜ï¸ Restaurar</button>
  <input id="buscador" class="search-box" placeholder="ğŸ” Buscar piloto o dorsal" oninput="render()">
</header>

<h1 class="section-title">ğŸ“˜ INFORMACIÃ“N GENERAL</h1>
<div class="info-box">
  <textarea id="infoGeneral" placeholder="Notas de competiciÃ³n, reglas, horarios, speakers notes..."
    oninput="guardarInfo()" style="min-height:120px;"></textarea>
</div>

<h1 class="section-title">ğŸ® PILOTOS EN PISTA</h1>
<div class="grid" id="gridPista"></div>

<h1 class="section-title">ğŸ TODOS LOS PILOTOS</h1>
<div class="grid" id="grid"></div>

<!-- FORMULARIO PILOTO -->
<div id="formulario" class="overlay">
  <button onclick="cerrarFormulario()">â¬… Volver</button>
  <h2>Nuevo Piloto</h2>

  <input id="n-nombre" placeholder="Piloto 1">
  <input id="n-piloto2" placeholder="Piloto 2 (opcional)">
  <input id="n-dorsal" placeholder="Dorsal">
  <input id="n-categoria" placeholder="CategorÃ­a principal">
  <input id="n-club" placeholder="Club / FederaciÃ³n">
  <textarea id="n-observaciones" placeholder="Observaciones / Notas del speaker"></textarea>
  <input type="file" id="n-foto" accept="image/*">

  <button onclick="guardarFormulario()">ğŸ’¾ Guardar</button>
</div>

<!-- FICHA -->
<div id="ficha" class="overlay">
  <button onclick="cerrarFicha()">â¬… Volver</button>
  <button onclick="editarPiloto()">âœï¸ Editar</button>

  <h2 id="f-nombre"></h2>
  <p id="f-piloto2"></p>
  <p id="f-dorsal"></p>
  <p id="f-club"></p>

  <h3>ğŸ“ Observaciones</h3>
  <div id="f-observaciones"></div>

  <button onclick="toggleEnPista()">ğŸ® En pista</button>

  <h3>ğŸ† Historial por CategorÃ­a y AÃ±o</h3>
  <div class="timeline" id="f-timeline"></div>
</div>

<input type="file" id="pdfInput" accept="application/pdf" hidden>

<div class="footer">
  <img src="logo-gaston.png">
  <img src="logo-rfem.png">
  <img src="logo-andalucia.png">
  <img src="logo-uim.png">
</div>

<script>
let competidores = JSON.parse(localStorage.getItem("rfemData")) || [];
let seleccionado = null;

document.getElementById("infoGeneral").value =
  localStorage.getItem("rfemInfo") || "";

function guardarInfo() {
  localStorage.setItem("rfemInfo", document.getElementById("infoGeneral").value);
}

function guardarDatos() {
  localStorage.setItem("rfemData", JSON.stringify(competidores));
}

function render() {
  guardarDatos();
  const grid = document.getElementById("grid");
  const pista = document.getElementById("gridPista");
  grid.innerHTML = "";
  pista.innerHTML = "";

  const q = document.getElementById("buscador").value.toLowerCase();

  competidores.forEach((p, i) => {
    if (p.enPista) pista.appendChild(crearCard(p, i));

    if (
      !q ||
      p.nombre.toLowerCase().includes(q) ||
      (p.dorsal || "").includes(q)
    ) {
      grid.appendChild(crearCard(p, i));
    }
  });
}

function crearCard(p, i) {
  const card = document.createElement("div");
  card.className = "card" + (p.enPista ? " en-pista" : "");
  card.innerHTML = `
    <img src="${p.foto || ''}">
    <div>${p.nombre}</div>
    <div class="dorsal">${p.dorsal || ""}</div>
    <div>${p.categoria || ""}</div>
  `;
  card.onclick = () => abrirFicha(i);
  return card;
}

function mostrarFormularioNuevo() {
  document.getElementById("formulario").style.display = "block";
}

function cerrarFormulario() {
  document.getElementById("formulario").style.display = "none";
}

function guardarFormulario() {
  const file = document.getElementById("n-foto").files[0];
  const reader = new FileReader();
  reader.onload = e => {
    competidores.push({
      nombre: n("n-nombre"),
      piloto2: n("n-piloto2"),
      dorsal: n("n-dorsal"),
      categoria: n("n-categoria"),
      club: n("n-club"),
      observaciones: n("n-observaciones"),
      resultados: [],
      foto: e.target.result,
      enPista: false
    });
    cerrarFormulario();
    render();
  };
  if (file) reader.readAsDataURL(file);
  else reader.onload({ target: { result: "" } });
}

function abrirFicha(i) {
  seleccionado = i;
  const p = competidores[i];
  f("f-nombre", p.nombre);
  f("f-piloto2", "Piloto 2: " + (p.piloto2 || "â€”"));
  f("f-dorsal", "Dorsal: " + p.dorsal);
  f("f-club", "Club: " + p.club);
  f("f-observaciones", p.observaciones || "â€”");

  const timeline = document.getElementById("f-timeline");
  timeline.innerHTML = "";

  p.resultados.forEach(r => {
    const div = document.createElement("div");
    div.className = "timeline-item";
    div.innerHTML = `
      <h3>${r.anio}</h3>
      <div>${r.categoria}</div>
      <div>ğŸ¥‡ Puesto: ${r.puesto}</div>
      <div>â­ ${r.puntos || ""}</div>
    `;
    timeline.appendChild(div);
  });

  document.getElementById("ficha").style.display = "block";
}

function cerrarFicha() {
  document.getElementById("ficha").style.display = "none";
}

function toggleEnPista() {
  competidores[seleccionado].enPista =
    !competidores[seleccionado].enPista;
  render();
}

/* ---------------- PDF IMPORTER ---------------- */

function activarImportPDF() {
  document.getElementById("pdfInput").click();
}

document.getElementById("pdfInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const data = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data }).promise;

  let fullText = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const text = await page.getTextContent();
    text.items.forEach(t => fullText += t.str + "\n");
  }

  procesarTextoPDF(fullText);
});

function procesarTextoPDF(texto) {
  const lineas = texto.split("\n");

  lineas.forEach(l => {
    if (l.includes("/") || l.match(/\d+\s+[A-Z]/)) {
      const partes = l.split(/\s{2,}/);
      if (partes.length >= 2) {
        const nombreRaw = partes[1];
        let p1 = nombreRaw;
        let p2 = "";

        if (nombreRaw.includes("/")) {
          [p1, p2] = nombreRaw.split("/");
        }

        competidores.push({
          nombre: p1.trim(),
          piloto2: p2.trim(),
          dorsal: partes[0].trim(),
          categoria: "Importado PDF",
          club: partes[2] || "",
          observaciones: "Importado automÃ¡ticamente RFEM",
          resultados: [{
            anio: new Date().getFullYear(),
            categoria: "PDF RFEM",
            puesto: "â€”",
            puntos: ""
          }],
          foto: "",
          enPista: false
        });
      }
    }
  });

  alert("âœ… PDF importado correctamente");
  render();
}

/* ---------------- UTIL ---------------- */

function exportarBackup() {
  const blob = new Blob([JSON.stringify(competidores, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "rfem_backup.json";
  a.click();
}

function importarBackup() {
  const i = document.createElement("input");
  i.type = "file";
  i.accept = "application/json";
  i.onchange = e => {
    const r = new FileReader();
    r.onload = () => {
      competidores = JSON.parse(r.result);
      render();
    };
    r.readAsText(e.target.files[0]);
  };
  i.click();
}

function mostrarRanking() {
  let lista = [];
  competidores.forEach(p => {
    const pts = p.resultados.reduce((s, r) => s + (parseInt(r.puntos) || 0), 0);
    lista.push({ nombre: p.nombre, puntos: pts });
  });
  lista.sort((a, b) => b.puntos - a.puntos);
  alert("ğŸ† Ranking\n\n" + lista.map((p, i) => `${i + 1}. ${p.nombre} â€” ${p.puntos}`).join("\n"));
}

function n(id) { return document.getElementById(id).value; }
function f(id, txt) { document.getElementById(id).innerText = txt; }

render();
</script>

</body>
</html>
