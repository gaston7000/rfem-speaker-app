<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RFEM Speaker PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:
    linear-gradient(rgba(5,10,25,0.85), rgba(5,10,25,0.85)),
    url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1920&q=80");
  background-size: cover;
  background-attachment: fixed;
  color: white;
}

header {
  padding: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  justify-content: center;
  background: rgba(5,10,25,0.7);
  backdrop-filter: blur(8px);
}

button {
  background: #00d1ff;
  border: none;
  padding: 16px 22px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 14px;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s;
}

button:hover {
  transform: scale(1.05);
  background: #00b4dd;
}

.section-title {
  text-align: center;
  font-size: 28px;
  margin: 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  padding: 20px;
}

.card {
  background: rgba(20,30,60,0.9);
  border-radius: 20px;
  padding: 14px;
  text-align: center;
  transition: transform 0.2s;
}

.card:hover {
  transform: scale(1.05);
}

.en-pista {
  border: 4px solid #00ff00;
  box-shadow: 0 0 25px #00ff00;
}

.card img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: 14px;
}

.dorsal {
  font-size: 36px;
  font-weight: bold;
}

.categoria {
  padding: 6px 12px;
  border-radius: 10px;
  display: inline-block;
  font-size: 14px;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(5,10,25,0.95);
  display: none;
  padding: 20px;
  overflow-y: auto;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

.footer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 40px;
  padding: 20px;
  background: rgba(0,0,0,0.6);
}

.footer img {
  height: 60px;
  opacity: 0.85;
}
</style>
</head>

<body>

<header>
  <button onclick="mostrarFormularioNuevo()">â• Nuevo Competidor</button>
  <button onclick="importarPDF()">ğŸ“„ Importar RFEM</button>
  <button onclick="importarMemoria()">ğŸ† Importar PalmarÃ©s</button>
  <button onclick="mostrarRanking()">ğŸ“Š Ranking</button>
  <button onclick="pantallaPublico()">ğŸ“º Pantalla PÃºblico</button>
  <button onclick="exportarBackup()">â˜ï¸ Backup</button>
  <button onclick="importarBackup()">â˜ï¸ Restaurar</button>
</header>

<h1 class="section-title">ğŸ® PILOTOS EN PISTA</h1>
<div class="grid" id="gridPista"></div>

<h1 class="section-title">ğŸ TODOS LOS COMPETIDORES</h1>
<div class="grid" id="grid"></div>

<!-- FORMULARIO PILOTO -->
<div id="formulario" class="overlay">
  <button onclick="cerrarFormulario()">â¬… Volver</button>
  <h2 id="form-title">Competidor</h2>

  <input id="n-nombre" placeholder="Nombre Piloto 1">
  <input id="n-dorsal" placeholder="Dorsal">
  <input id="n-categoria" placeholder="CategorÃ­a principal">
  <input id="n-piloto2" placeholder="Piloto 2 (opcional)">
  <select id="n-tipo">
    <option>Motos de agua</option>
    <option>Barcos</option>
  </select>
  <input id="n-club" placeholder="Club">
  <input id="n-embarcacion" placeholder="Marca y modelo embarcaciÃ³n">
  <input type="file" id="n-foto" accept="image/*">

  <button onclick="guardarFormulario()">ğŸ’¾ Guardar</button>
</div>

<!-- FICHA -->
<div id="ficha" class="overlay">
  <button onclick="cerrarFicha()">â¬… Volver</button>
  <button onclick="editarPiloto()">âœï¸ Editar</button>
  <button onclick="eliminarPiloto()" style="background:#ff0033">ğŸ—‘ï¸ Eliminar</button>

  <h2 id="f-nombre"></h2>
  <p id="f-piloto2"></p>
  <p id="f-dorsal"></p>
  <p id="f-categoria"></p>
  <p id="f-tipo"></p>
  <p id="f-club"></p>
  <p id="f-embarcacion"></p>

  <button onclick="toggleEnPista()">ğŸ® En pista</button>

  <h3>ğŸ† TÃ­tulos y Clasificaciones Anuales</h3>
  <div id="f-resultados"></div>
  <button onclick="mostrarResultadoForm()">â• AÃ±adir ClasificaciÃ³n</button>
</div>

<!-- RESULTADO -->
<div id="resultadoForm" class="overlay">
  <button onclick="cerrarResultadoForm()">â¬… Volver</button>
  <h2>Nueva ClasificaciÃ³n</h2>

  <input id="r-anio" placeholder="AÃ±o">
  <input id="r-competicion" placeholder="Campeonato / CompeticiÃ³n">
  <input id="r-categoria" placeholder="CategorÃ­a">
  <input id="r-puesto" placeholder="Puesto final (1,2,3,4...)">
  <input id="r-piloto2" placeholder="Piloto 2 (si aplica)">
  <input id="r-titulo" placeholder="TÃ­tulo obtenido (CampeÃ³n, SubcampeÃ³n, etc)">
  <input id="r-tiempo" placeholder="Mejor tiempo">
  <input id="r-puntos" placeholder="Puntos totales">
  <input id="r-sanciones" placeholder="Sanciones">

  <button onclick="guardarResultado()">ğŸ’¾ Guardar</button>
</div>

<input type="file" id="pdfInput" accept="application/pdf" style="display:none">

<div class="footer">
  <img src="logo-gaston.png">
  <img src="logo-rfem.png">
  <img src="logo-andalucia.png">
  <img src="logo-uim.png">
</div>

<script>
let competidores = JSON.parse(localStorage.getItem("rfemData")) || [];
let seleccionado = null;
let editandoIndex = null;

function guardarDatos() {
  localStorage.setItem("rfemData", JSON.stringify(competidores));
}

function render() {
  guardarDatos();
  const grid = document.getElementById("grid");
  const pista = document.getElementById("gridPista");

  grid.innerHTML = "";
  pista.innerHTML = "";

  competidores.forEach((p, i) => {
    const card = document.createElement("div");
    card.className = "card" + (p.enPista ? " en-pista" : "");
    card.innerHTML = `
      <img src="${p.foto || ''}">
      <div>${p.nombre}</div>
      <div class="dorsal">${p.dorsal || ""}</div>
      <div class="categoria">${p.categoria || ""}</div>
    `;
    card.onclick = () => abrirFicha(i);

    if (p.enPista) {
      const clone = card.cloneNode(true);
      clone.onclick = () => abrirFicha(i);
      pista.appendChild(clone);
    }

    grid.appendChild(card);
  });
}

function mostrarFormularioNuevo() {
  editandoIndex = null;
  limpiarFormulario();
  document.getElementById("formulario").style.display = "block";
}

function limpiarFormulario() {
  ["n-nombre","n-dorsal","n-categoria","n-piloto2","n-club","n-embarcacion"].forEach(id=>{
    document.getElementById(id).value="";
  });
  document.getElementById("n-tipo").value="Motos de agua";
  document.getElementById("n-foto").value="";
}

function guardarFormulario() {
  const file = document.getElementById("n-foto").files[0];
  const reader = new FileReader();

  reader.onload = e => guardarFinal(e.target.result);
  if (file) reader.readAsDataURL(file);
  else guardarFinal(null);
}

function guardarFinal(foto) {
  if (editandoIndex !== null) {
    const p = competidores[editandoIndex];
    p.nombre = n("n-nombre");
    p.dorsal = n("n-dorsal");
    p.categoria = n("n-categoria");
    p.piloto2 = n("n-piloto2");
    p.tipo = n("n-tipo");
    p.club = n("n-club");
    p.embarcacion = n("n-embarcacion");
    if (foto) p.foto = foto;
  } else {
    competidores.push({
      nombre: n("n-nombre"),
      dorsal: n("n-dorsal"),
      categoria: n("n-categoria"),
      piloto2: n("n-piloto2"),
      tipo: n("n-tipo"),
      club: n("n-club"),
      embarcacion: n("n-embarcacion"),
      resultados: [],
      enPista: false,
      foto: foto || ""
    });
  }

  cerrarFormulario();
  render();
}

function abrirFicha(i) {
  seleccionado = i;
  const p = competidores[i];

  f("f-nombre", p.nombre);
  f("f-piloto2", "Piloto 2: " + (p.piloto2 || "â€”"));
  f("f-dorsal", "Dorsal: " + p.dorsal);
  f("f-categoria", "CategorÃ­a: " + p.categoria);
  f("f-tipo", "Tipo: " + p.tipo);
  f("f-club", "Club: " + p.club);
  f("f-embarcacion", "EmbarcaciÃ³n: " + p.embarcacion);

  const r = document.getElementById("f-resultados");
  r.innerHTML = "";
  p.resultados.forEach(res => {
    r.innerHTML += `
      <div style="margin-bottom:10px;padding:10px;background:#112;border-radius:10px">
        ğŸ—“ï¸ ${res.anio} | ğŸ ${res.competicion} | ğŸ“Š ${res.categoria}<br>
        ğŸ¥‡ Puesto: ${res.puesto} | ğŸ† TÃ­tulo: ${res.titulo || "â€”"}<br>
        ğŸ‘¥ Piloto 2: ${res.piloto2 || "â€”"} | â­ Puntos: ${res.puntos || "â€”"}
      </div>
    `;
  });

  document.getElementById("ficha").style.display = "block";
}

function guardarResultado() {
  competidores[seleccionado].resultados.push({
    anio: n("r-anio"),
    competicion: n("r-competicion"),
    categoria: n("r-categoria"),
    puesto: n("r-puesto"),
    piloto2: n("r-piloto2"),
    titulo: n("r-titulo"),
    tiempo: n("r-tiempo"),
    puntos: n("r-puntos"),
    sanciones: n("r-sanciones")
  });

  cerrarResultadoForm();
  render();
  abrirFicha(seleccionado);
}

function toggleEnPista() {
  competidores[seleccionado].enPista = !competidores[seleccionado].enPista;
  render();
}

function eliminarPiloto() {
  if (!confirm("Â¿Eliminar este competidor y todo su historial?")) return;
  competidores.splice(seleccionado, 1);
  cerrarFicha();
  render();
}

function mostrarResultadoForm() {
  document.getElementById("resultadoForm").style.display = "block";
}
function cerrarResultadoForm() {
  document.getElementById("resultadoForm").style.display = "none";
}
function cerrarFormulario() {
  document.getElementById("formulario").style.display = "none";
}
function cerrarFicha() {
  document.getElementById("ficha").style.display = "none";
}

function n(id) { return document.getElementById(id).value; }
function f(id, txt) { document.getElementById(id).innerText = txt; }

function exportarBackup() {
  const blob = new Blob([JSON.stringify(competidores,null,2)],{type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "rfem_backup.json";
  a.click();
}

function importarBackup() {
  const i = document.createElement("input");
  i.type="file";
  i.accept="application/json";
  i.onchange=e=>{
    const r=new FileReader();
    r.onload=()=>{
      competidores=JSON.parse(r.result);
      render();
    };
    r.readAsText(e.target.files[0]);
  };
  i.click();
}

render();
</script>

</body>
</html>