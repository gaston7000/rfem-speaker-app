<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>RFEM Speaker PRO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background:
    linear-gradient(rgba(5,10,25,0.85), rgba(5,10,25,0.85)),
    url("https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1920&q=80");
  background-size: cover;
  background-attachment: fixed;
  color: white;
}

header {
  padding: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  justify-content: center;
  background: rgba(5,10,25,0.7);
  backdrop-filter: blur(8px);
}

button {
  background: #00d1ff;
  border: none;
  padding: 16px 22px;
  font-size: 18px;
  font-weight: bold;
  border-radius: 14px;
  cursor: pointer;
  transition: transform 0.2s, background 0.2s;
}

button:hover {
  transform: scale(1.05);
  background: #00b4dd;
}

.section-title {
  text-align: center;
  font-size: 28px;
  margin: 20px;
  letter-spacing: 1px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 16px;
  padding: 20px;
}

.card {
  background: rgba(20,30,60,0.9);
  border-radius: 20px;
  padding: 14px;
  text-align: center;
  transition: transform 0.2s;
}

.card:hover {
  transform: scale(1.05);
}

.en-pista {
  border: 4px solid #00ff00;
  box-shadow: 0 0 25px #00ff00;
}

.card img {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: 14px;
}

.dorsal {
  font-size: 36px;
  font-weight: bold;
  margin: 10px 0;
}

.categoria {
  padding: 6px 12px;
  border-radius: 10px;
  display: inline-block;
  font-size: 14px;
  margin-bottom: 6px;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(5,10,25,0.95);
  display: none;
  padding: 20px;
  overflow-y: auto;
}

.overlay h2 {
  text-align: center;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 10px;
  border: none;
  font-size: 16px;
}

.footer {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 40px;
  padding: 20px;
  background: rgba(0,0,0,0.6);
}

.footer img {
  height: 60px;
  opacity: 0.85;
  transition: transform 0.2s;
}

.footer img:hover {
  transform: scale(1.1);
}
</style>
</head>

<body>

<header>
  <button onclick="mostrarFormularioNuevo()">â• Nuevo Competidor</button>
  <button onclick="importarPDF()">ğŸ“„ Importar RFEM (PDF)</button>
  <button onclick="mostrarRanking()">ğŸ“Š Ranking</button>
  <button onclick="pantallaPublico()">ğŸ“º Pantalla PÃºblico</button>
  <button onclick="exportarBackup()">â˜ï¸ Backup</button>
  <button onclick="importarBackup()">â˜ï¸ Restaurar</button>
</header>

<h1 class="section-title">ğŸ® PILOTOS EN PISTA</h1>
<div class="grid" id="gridPista"></div>

<h1 class="section-title">ğŸ TODOS LOS COMPETIDORES</h1>
<div class="grid" id="grid"></div>

<!-- FORMULARIO COMPETIDOR -->
<div id="formulario" class="overlay">
  <button onclick="cerrarFormulario()">â¬… Volver a Inicio</button>
  <h2 id="form-title">Nuevo Competidor</h2>

  <input id="n-nombre" placeholder="Nombre completo">
  <input id="n-dorsal" placeholder="Dorsal">
  <input id="n-categoria" placeholder="CategorÃ­a (GP2, GT60, etc)">
  <select id="n-tipo">
    <option>Motos de agua</option>
    <option>Barcos</option>
  </select>
  <input id="n-club" placeholder="Club">
  <input id="n-embarcacion" placeholder="Marca y modelo de embarcaciÃ³n">
  <input type="file" id="n-foto" accept="image/*">

  <button onclick="guardarFormulario()">ğŸ’¾ Guardar</button>
</div>

<!-- FICHA -->
<div id="ficha" class="overlay">
  <button onclick="cerrarFicha()">â¬… Volver a Inicio</button>
  <button onclick="editarPiloto()">âœï¸ Editar Piloto</button>
  <button onclick="eliminarPiloto()" style="background:#ff0033">ğŸ—‘ï¸ Eliminar Piloto</button>

  <h2 id="f-nombre"></h2>

  <p id="f-dorsal"></p>
  <p id="f-categoria"></p>
  <p id="f-tipo"></p>
  <p id="f-club"></p>
  <p id="f-embarcacion"></p>

  <button onclick="toggleEnPista()">ğŸ® En Pista</button>
  <button onclick="enlazarFamiliar()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Enlazar Familiar</button>

  <h3>ğŸ Resultados</h3>
  <div id="f-resultados"></div>
  <button onclick="mostrarResultadoForm()">â• AÃ±adir Resultado</button>
</div>

<!-- RESULTADO -->
<div id="resultadoForm" class="overlay">
  <button onclick="cerrarResultadoForm()">â¬… Volver a Ficha</button>
  <h2>Nuevo Resultado</h2>

  <input id="r-anio" placeholder="AÃ±o (2005â€“2024)">
  <input id="r-competicion" placeholder="CompeticiÃ³n">
  <input id="r-puesto" placeholder="Puesto">
  <input id="r-tiempo" placeholder="Tiempo">
  <input id="r-puntos" placeholder="Puntos">
  <input id="r-sanciones" placeholder="Sanciones">

  <button onclick="guardarResultado()">ğŸ’¾ Guardar Resultado</button>
</div>

<!-- INPUT PDF OCULTO -->
<input type="file" id="pdfInput" accept="application/pdf" style="display:none">

<!-- FOOTER LOGOS -->
<div class="footer">
  <img src="logo-gaston.png" alt="Gaston Iglesias Sport Marketing">
  <img src="logo-rfem.png" alt="RFEM">
  <img src="logo-andalucia.png" alt="FederaciÃ³n Andaluza MotonÃ¡utica">
  <img src="logo-uim.png" alt="UIM">
</div>

<script>
let competidores = JSON.parse(localStorage.getItem("rfemData")) || [];
let seleccionado = null;
let editandoIndex = null;

function guardarDatos() {
  localStorage.setItem("rfemData", JSON.stringify(competidores));
}

function colorCategoria(cat) {
  if (!cat) return "#00d1ff";
  const c = cat.toLowerCase();
  if (c.includes("gp")) return "#ff0055";
  if (c.includes("gt")) return "#00ff99";
  return "#00d1ff";
}

function render() {
  guardarDatos();
  const grid = document.getElementById("grid");
  const gridPista = document.getElementById("gridPista");
  grid.innerHTML = "";
  gridPista.innerHTML = "";

  competidores.forEach((p, i) => {
    const card = document.createElement("div");
    card.className = "card" + (p.enPista ? " en-pista" : "");
    card.innerHTML = `
      <img src="${p.foto || ''}">
      <div>${p.nombre}</div>
      <div class="dorsal">${p.dorsal || ""}</div>
      <div class="categoria" style="background:${colorCategoria(p.categoria)}">
        ${p.categoria || ""}
      </div>
    `;
    card.onclick = () => abrirFicha(i);

    if (p.enPista) {
      const clone = card.cloneNode(true);
      clone.onclick = () => abrirFicha(i);
      gridPista.appendChild(clone);
    }
    grid.appendChild(card);
  });
}

function mostrarFormularioNuevo() {
  editandoIndex = null;
  document.getElementById("form-title").innerText = "Nuevo Competidor";
  limpiarFormulario();
  document.getElementById("formulario").style.display = "block";
}

function editarPiloto() {
  editandoIndex = seleccionado;
  const p = competidores[seleccionado];

  document.getElementById("form-title").innerText = "Editar Competidor";
  document.getElementById("n-nombre").value = p.nombre;
  document.getElementById("n-dorsal").value = p.dorsal;
  document.getElementById("n-categoria").value = p.categoria;
  document.getElementById("n-tipo").value = p.tipo;
  document.getElementById("n-club").value = p.club;
  document.getElementById("n-embarcacion").value = p.embarcacion;

  document.getElementById("ficha").style.display = "none";
  document.getElementById("formulario").style.display = "block";
}

function limpiarFormulario() {
  document.getElementById("n-nombre").value = "";
  document.getElementById("n-dorsal").value = "";
  document.getElementById("n-categoria").value = "";
  document.getElementById("n-tipo").value = "Motos de agua";
  document.getElementById("n-club").value = "";
  document.getElementById("n-embarcacion").value = "";
  document.getElementById("n-foto").value = "";
}

function cerrarFormulario() {
  document.getElementById("formulario").style.display = "none";
}

function guardarFormulario() {
  const file = document.getElementById("n-foto").files[0];
  const reader = new FileReader();

  reader.onload = e => {
    guardarFinal(e.target.result);
  };

  if (file) {
    reader.readAsDataURL(file);
  } else {
    guardarFinal(null);
  }
}

function guardarFinal(fotoData) {
  if (editandoIndex !== null) {
    const p = competidores[editandoIndex];
    p.nombre = document.getElementById("n-nombre").value;
    p.dorsal = document.getElementById("n-dorsal").value;
    p.categoria = document.getElementById("n-categoria").value;
    p.tipo = document.getElementById("n-tipo").value;
    p.club = document.getElementById("n-club").value;
    p.embarcacion = document.getElementById("n-embarcacion").value;
    if (fotoData) p.foto = fotoData;
  } else {
    const nuevo = {
      nombre: document.getElementById("n-nombre").value,
      dorsal: document.getElementById("n-dorsal").value,
      categoria: document.getElementById("n-categoria").value,
      tipo: document.getElementById("n-tipo").value,
      club: document.getElementById("n-club").value,
      embarcacion: document.getElementById("n-embarcacion").value,
      familia: [],
      resultados: [],
      enPista: false,
      foto: fotoData || ""
    };
    competidores.push(nuevo);
  }

  cerrarFormulario();
  render();
}

function abrirFicha(i) {
  seleccionado = i;
  const p = competidores[i];

  document.getElementById("f-nombre").innerText = p.nombre;
  document.getElementById("f-dorsal").innerText = "Dorsal: " + p.dorsal;
  document.getElementById("f-categoria").innerText = "CategorÃ­a: " + p.categoria;
  document.getElementById("f-tipo").innerText = "Tipo: " + p.tipo;
  document.getElementById("f-club").innerText = "Club: " + p.club;
  document.getElementById("f-embarcacion").innerText = "EmbarcaciÃ³n: " + p.embarcacion;

  const res = document.getElementById("f-resultados");
  res.innerHTML = "";
  p.resultados.forEach(r => {
    res.innerHTML += `
      <div>
        ${r.anio} | ${r.competicion} | Puesto ${r.puesto} | â­ ${r.puntos || 0}
      </div>
    `;
  });

  document.getElementById("ficha").style.display = "block";
}

function cerrarFicha() {
  document.getElementById("ficha").style.display = "none";
}

function toggleEnPista() {
  const p = competidores[seleccionado];
  p.enPista = !p.enPista;
  render();
  abrirFicha(seleccionado);
}

function enlazarFamiliar() {
  const nombre = prompt("Nombre del familiar:");
  if (!nombre) return;
  competidores[seleccionado].familia.push(nombre);
  render();
}

function mostrarResultadoForm() {
  document.getElementById("resultadoForm").style.display = "block";
}

function cerrarResultadoForm() {
  document.getElementById("resultadoForm").style.display = "none";
}

function guardarResultado() {
  const p = competidores[seleccionado];
  p.resultados.push({
    anio: document.getElementById("r-anio").value,
    competicion: document.getElementById("r-competicion").value,
    puesto: document.getElementById("r-puesto").value,
    tiempo: document.getElementById("r-tiempo").value,
    puntos: document.getElementById("r-puntos").value,
    sanciones: document.getElementById("r-sanciones").value
  });
  cerrarResultadoForm();
  render();
}

function eliminarPiloto() {
  if (seleccionado === null) return;

  const p = competidores[seleccionado];
  const confirmar = confirm(
    "âš ï¸ Vas a eliminar a:\n\n" +
    p.nombre +
    "\n\nSe borrarÃ¡n TODOS sus datos y resultados.\n\nÂ¿Confirmas?"
  );

  if (!confirmar) return;

  competidores.splice(seleccionado, 1);
  seleccionado = null;
  cerrarFicha();
  render();
}

function mostrarRanking() {
  const anio = prompt("AÃ±o (2005â€“2024)");
  const categoria = prompt("CategorÃ­a");

  let lista = [];

  competidores.forEach(p => {
    p.resultados.forEach(r => {
      if (r.anio == anio && p.categoria.toLowerCase() == categoria.toLowerCase()) {
        lista.push({ nombre: p.nombre, puntos: parseInt(r.puntos || 0) });
      }
    });
  });

  lista.sort((a, b) => b.puntos - a.puntos);

  alert(
    "RANKING " + categoria + " " + anio + "\n\n" +
    lista.map((p, i) => `${i + 1}. ${p.nombre} â€” ${p.puntos} pts`).join("\n")
  );
}

function pantallaPublico() {
  const win = window.open("", "publico");
  win.document.write(`
    <html>
    <body style="background:black;color:white;font-family:sans-serif;padding:20px">
      <h1>CLASIFICACIÃ“N EN VIVO</h1>
      <div id="lista"></div>
      <script>
        function actualizar() {
          const datos = JSON.parse(localStorage.getItem("rfemData") || "[]");
          let lista = [];
          datos.forEach(p => {
            const total = p.resultados.reduce((s, r) => s + (parseInt(r.puntos)||0), 0);
            lista.push({nombre:p.nombre, puntos:total});
          });
          lista.sort((a,b)=>b.puntos-a.puntos);

          const div = document.getElementById("lista");
          div.innerHTML="";
          lista.slice(0,10).forEach((p,i)=>{
            div.innerHTML+=\`<div style="font-size:36px;margin:10px">#\${i+1} \${p.nombre} â€” â­ \${p.puntos}</div>\`;
          });
        }
        setInterval(actualizar,2000);
        actualizar();
      <\/script>
    </body>
    </html>
  `);
}

/* ===== PDF IMPORTADOR ROBUSTO ===== */
document.getElementById("pdfInput").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function() {
    const typedarray = new Uint8Array(this.result);

    pdfjsLib.getDocument(typedarray).promise.then(async pdf => {
      let textoCompleto = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str);
        textoCompleto += strings.join(" ") + "\n";
      }

      procesarTextoRFEM(textoCompleto);
    });
  };
  reader.readAsArrayBuffer(file);
});

function importarPDF() {
  document.getElementById("pdfInput").click();
}

function procesarTextoRFEM(texto) {
  alert("ğŸ“„ PDF cargado\n\nProcesando memoria RFEM...\nEsto puede tardar unos segundos.");

  const lineas = texto.split("\n");
  let creados = 0;

  lineas.forEach(l => {
    const linea = l.trim();
    if (!/^\d+/.test(linea)) return;

    const limpia = linea.replace(/\s+/g, " ");
    const partes = limpia.split(" ");
    if (partes.length < 3) return;

    const puesto = partes[0];
    const puntos = partes[partes.length - 1];
    if (isNaN(puntos)) return;

    let nombrePartes = partes.slice(1, partes.length - 1);
    nombrePartes = nombrePartes.filter(p => p.length > 3);

    const nombre = nombrePartes.join(" ").replace(",", "").trim();
    if (!nombre) return;

    let piloto = competidores.find(
      p => p.nombre.toLowerCase() === nombre.toLowerCase()
    );

    if (!piloto) {
      piloto = {
        nombre: nombre,
        dorsal: "",
        categoria: "",
        tipo: "",
        club: "",
        embarcacion: "",
        familia: [],
        resultados: [],
        enPista: false,
        foto: ""
      };
      competidores.push(piloto);
      creados++;
    }

    piloto.resultados.push({
      anio: new Date().getFullYear(),
      competicion: "RFEM Importado",
      puesto: puesto,
      tiempo: "",
      puntos: puntos,
      sanciones: ""
    });
  });

  render();
  alert("âœ… ImportaciÃ³n completada\n\nPilotos creados: " + creados + "\n\nRevisa y completa los datos.");
}

function exportarBackup() {
  const data = JSON.stringify(competidores, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "rfem_backup.json";
  a.click();
}

function importarBackup() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e => {
    const reader = new FileReader();
    reader.onload = () => {
      competidores = JSON.parse(reader.result);
      render();
    };
    reader.readAsText(e.target.files[0]);
  };

  input.click();
}

render();
</script>

</body>
</html>